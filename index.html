<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PaintGem">
<meta name="theme-color" content="#0c0f1a">
<title>Paint Gem Tracker</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0c0f1a;
    --card: #111827;
    --border: #1e293b;
    --border-light: #2d3555;
    --text: #e2e8f0;
    --text-bright: #e0e7ff;
    --text-dim: #64748b;
    --text-dimmer: #475569;
    --purple: #7c3aed;
    --purple-light: #a78bfa;
    --purple-glow: rgba(124, 58, 237, 0.3);
    --pink: #c084fc;
    --cyan: #22d3ee;
    --green: #34d399;
    --red: #ef4444;
    --input-bg: #151a2e;
    --font-display: 'Playfair Display', serif;
    --font-body: 'DM Sans', sans-serif;
  }

  body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    min-height: 100dvh;
    -webkit-tap-highlight-color: transparent;
    overscroll-behavior: none;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
  }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }

  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  input[type="number"] { -moz-appearance: textfield; }

  /* Animations */
  @keyframes sparkle-fall {
    0% { transform: translateY(0) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
  }
  @keyframes slide-up {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  @keyframes fade-in {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes gem-shimmer {
    0% { background-position: -200% center; }
    100% { background-position: 200% center; }
  }
  @keyframes pulse-glow {
    from { opacity: 0.85; }
    to { opacity: 1; }
  }
  @keyframes check-pop {
    0% { transform: scale(0); }
    60% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }
  @keyframes toast-in {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  @keyframes toast-out {
    from { transform: translateY(0); opacity: 1; }
    to { transform: translateY(20px); opacity: 0; }
  }

  /* Base elements */
  .screen { min-height: 100vh; min-height: 100dvh; background: var(--bg); }
  .header { padding: 16px 20px; display: flex; align-items: center; gap: 12; }
  .back-btn {
    background: none; border: none; color: var(--purple-light);
    font-size: 18px; cursor: pointer; padding: 8px 0;
    font-family: var(--font-body);
  }
  .btn {
    background: linear-gradient(135deg, var(--purple), #a855f7);
    border: none; color: #fff; padding: 14px 28px; border-radius: 14px;
    font-size: 16px; font-weight: 600; font-family: var(--font-body);
    cursor: pointer; transition: all 0.2s; -webkit-tap-highlight-color: transparent;
  }
  .btn:active { transform: scale(0.97); }
  .btn-outline {
    background: transparent; border: 1px solid var(--border-light);
    color: #94a3b8; padding: 12px 20px; border-radius: 14px;
    font-size: 14px; font-weight: 600; font-family: var(--font-body);
    cursor: pointer; transition: all 0.2s;
  }
  .btn-big {
    padding: 18px 28px; font-size: 18px; border-radius: 16px;
    box-shadow: 0 4px 20px var(--purple-glow);
    width: 100%;
  }
  .btn-disabled {
    background: var(--border-light) !important;
    color: var(--text-dim) !important;
    cursor: not-allowed !important;
    box-shadow: none !important;
  }

  .input {
    width: 100%; padding: 14px 16px; background: var(--input-bg);
    border: 1px solid var(--border-light); border-radius: 12px;
    color: var(--text); font-size: 16px; font-family: var(--font-body);
    outline: none; transition: border-color 0.2s;
  }
  .input:focus { border-color: var(--purple-light); }
  .input::placeholder { color: var(--text-dimmer); }

  .label {
    color: #94a3b8; font-size: 13px; font-weight: 600;
    display: block; margin-bottom: 6px;
  }

  /* Sparkle overlay */
  .sparkle {
    position: fixed; border-radius: 50%; z-index: 9999; pointer-events: none;
  }

  /* Toast notification */
  .toast {
    position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
    background: var(--card); border: 1px solid var(--border-light);
    padding: 12px 24px; border-radius: 12px; font-size: 14px;
    color: var(--text); z-index: 9998; white-space: nowrap;
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  }

  /* Kit list item */
  .kit-item {
    width: 100%; background: var(--card);
    border: 1px solid var(--border); border-radius: 14px;
    padding: 14px 16px; margin-bottom: 8px;
    display: flex; align-items: center; gap: 14;
    cursor: pointer; text-align: left; font-family: var(--font-body);
    transition: all 0.15s;
  }
  .kit-item:active { transform: scale(0.98); }
  .kit-item.complete { border-color: rgba(52, 211, 153, 0.15); }

  /* Design list item */
  .design-item {
    display: flex; align-items: center; gap: 12;
    padding: 14px 16px; background: var(--card);
    border: 1px solid var(--border); border-radius: 12px;
    margin-bottom: 6px; cursor: pointer; transition: all 0.15s;
  }
  .design-item:active { transform: scale(0.98); }
  .design-item.done { border-color: rgba(52, 211, 153, 0.15); }

  .design-checkbox {
    width: 28px; height: 28px; border-radius: 50%;
    border: 2px solid var(--border-light); display: flex;
    align-items: center; justify-content: center; flex-shrink: 0;
    transition: all 0.2s;
  }
  .design-checkbox.checked {
    background: var(--green); border-color: var(--green);
    animation: check-pop 0.3s ease;
  }

  /* Filter pills */
  .pill {
    background: transparent; border: 1px solid var(--border);
    color: var(--text-dim); padding: 6px 14px; border-radius: 20px;
    font-size: 13px; font-weight: 600; cursor: pointer;
    white-space: nowrap; font-family: var(--font-body); transition: all 0.15s;
  }
  .pill.active {
    background: rgba(167, 139, 250, 0.15);
    border-color: var(--purple-light);
    color: var(--purple-light);
  }

  /* Stats cards */
  .stat-card {
    flex: 1; background: var(--card); border-radius: 12px;
    padding: 12px 10px; text-align: center; border: 1px solid var(--border);
  }

  /* FAB */
  .fab {
    position: fixed; bottom: 24px; right: 24px;
    width: 60px; height: 60px; border-radius: 50%;
    background: linear-gradient(135deg, var(--purple), #a855f7);
    border: none; color: #fff; font-size: 28px; font-weight: 300;
    cursor: pointer; box-shadow: 0 4px 24px rgba(124, 58, 237, 0.4);
    display: flex; align-items: center; justify-content: center;
    z-index: 100;
  }
  .fab:active { transform: scale(0.93); }

  /* Spinner area */
  .spinner-box {
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(168, 85, 247, 0.05));
    border: 1px solid rgba(124, 58, 237, 0.15);
    border-radius: 20px; padding: 30px 20px; min-height: 100px; margin-bottom: 30px;
  }

  /* Progress bar */
  .progress-bar {
    height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;
  }
  .progress-fill {
    height: 100%; border-radius: 4px; transition: width 0.5s ease;
  }

  /* Rename input inline */
  .rename-input {
    background: var(--input-bg); border: 1px solid var(--purple-light);
    border-radius: 8px; color: var(--text); font-size: 14px;
    font-family: var(--font-body); padding: 6px 10px; outline: none;
    width: 100%;
  }

  /* Status indicator */
  .status-dot {
    position: fixed; top: 12px; right: 16px; width: 8px; height: 8px;
    border-radius: 50%; z-index: 200;
  }

  /* Hidden */
  .hidden { display: none !important; }

  /* Modal overlay */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    display: flex; align-items: center; justify-content: center;
    z-index: 500; padding: 20px; animation: fade-in 0.2s ease;
  }
  .modal-content {
    background: var(--bg); border: 1px solid var(--border-light);
    border-radius: 20px; padding: 24px; width: 100%; max-width: 340px;
    animation: slide-up 0.3s ease;
  }
</style>
</head>
<body>

<div id="app"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG â€” Replace these values with your own!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyCuPIasrn-pOYEkaQRQaJpvVeZfOhaVYJI",
  authDomain: "my-project-first-try-efd9b.firebaseapp.com",
  databaseURL: "https://my-project-first-try-efd9b.firebaseio.com",
  projectId: "my-project-first-try-efd9b",
  storageBucket: "my-project-first-try-efd9b.firebasestorage.app",
  messagingSenderId: "239272444767",
  appId: "1:239272444767:web:83baa498250318a7f3ecea",
  measurementId: "G-T91MW46R8M"
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Initialize Firebase
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let db = null;
let kitsCollection = null;
let firebaseReady = false;

try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();

  // Enable offline persistence
  db.enablePersistence({ synchronizeTabs: false }).catch(err => {
    console.warn('Persistence failed:', err.code);
  });

  kitsCollection = db.collection('kits');
  firebaseReady = true;
} catch (e) {
  console.error('Firebase init failed:', e);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  kits: [],
  loaded: false,
  view: 'home', // home | add | edit | detail | picker
  selectedKitId: null,
  filter: 'all',
  search: '',
  spinning: false,
  pickerResult: null,
  bulkMode: false,
  editingDesignId: null,
  toast: null,
  toastTimer: null,
  // add form
  addNumber: '',
  addName: '',
  addTotal: '',
  addCompleted: '0',
  // edit form
  editNumber: '',
  editName: '',
  editTotal: '',
  // modal
  showDeleteModal: false,
  deleteTargetId: null,
};

function getSelectedKit() {
  return state.kits.find(k => k.id === state.selectedKitId) || null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE DATA OPERATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadKitsFromFirebase() {
  if (!firebaseReady) {
    state.loaded = true;
    render();
    return;
  }

  kitsCollection.orderBy('number', 'asc').onSnapshot(snapshot => {
    state.kits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    state.loaded = true;
    render();
  }, err => {
    console.error('Firestore listen error:', err);
    state.loaded = true;
    render();
  });
}

async function addKitToFirebase(kitData) {
  if (!firebaseReady) return;
  try {
    await kitsCollection.add(kitData);
  } catch (e) {
    console.error('Add failed:', e);
    showToast('Failed to save â€” check connection');
  }
}

async function updateKitInFirebase(id, updates) {
  if (!firebaseReady) return;
  try {
    await kitsCollection.doc(id).update(updates);
  } catch (e) {
    console.error('Update failed:', e);
    showToast('Failed to save â€” check connection');
  }
}

async function deleteKitFromFirebase(id) {
  if (!firebaseReady) return;
  try {
    await kitsCollection.doc(id).delete();
  } catch (e) {
    console.error('Delete failed:', e);
    showToast('Failed to delete â€” check connection');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
}

function showToast(msg) {
  if (state.toastTimer) clearTimeout(state.toastTimer);
  state.toast = msg;
  render();
  state.toastTimer = setTimeout(() => {
    state.toast = null;
    render();
  }, 2500);
}

function createDesigns(total, completed = 0) {
  const designs = [];
  for (let i = 0; i < total; i++) {
    designs.push({
      id: generateId(),
      name: '',
      completed: i < completed,
    });
  }
  return designs;
}

function getKitStats(kit) {
  const completed = kit.designs ? kit.designs.filter(d => d.completed).length : 0;
  const total = kit.designs ? kit.designs.length : 0;
  const pct = total > 0 ? Math.round((completed / total) * 100) : 0;
  return { completed, total, pct, isComplete: completed >= total && total > 0 };
}

function getOverallStats() {
  let totalKits = state.kits.length;
  let completedKits = 0, inProgressKits = 0, notStartedKits = 0;
  let totalDesigns = 0, completedDesigns = 0;

  state.kits.forEach(kit => {
    const s = getKitStats(kit);
    totalDesigns += s.total;
    completedDesigns += s.completed;
    if (s.isComplete) completedKits++;
    else if (s.completed > 0) inProgressKits++;
    else notStartedKits++;
  });

  return { totalKits, completedKits, inProgressKits, notStartedKits, totalDesigns, completedDesigns };
}

function getFilteredKits() {
  return state.kits
    .filter(k => {
      const s = getKitStats(k);
      if (state.filter === 'not_started') return s.completed === 0;
      if (state.filter === 'in_progress') return s.completed > 0 && !s.isComplete;
      if (state.filter === 'completed') return s.isComplete;
      return true;
    })
    .filter(k => {
      if (!state.search) return true;
      const q = state.search.toLowerCase();
      return k.name.toLowerCase().includes(q) || String(k.number).includes(q);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SVG HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function progressRingSvg(completed, total, size = 44) {
  const pct = total > 0 ? completed / total : 0;
  const r = (size - 6) / 2;
  const circ = 2 * Math.PI * r;
  const offset = circ * (1 - pct);
  const color = pct >= 1 ? 'var(--green)' : pct > 0 ? 'var(--purple-light)' : '#334155';
  const checkmark = pct >= 1
    ? `<text x="${size/2}" y="${size/2 + 1}" text-anchor="middle" dominant-baseline="middle" fill="var(--green)" font-size="16">âœ“</text>`
    : '';

  return `<svg width="${size}" height="${size}" style="flex-shrink:0">
    <circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="var(--border)" stroke-width="4"/>
    <circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="${color}" stroke-width="4"
      stroke-dasharray="${circ}" stroke-dashoffset="${offset}" stroke-linecap="round"
      transform="rotate(-90 ${size/2} ${size/2})" style="transition:stroke-dashoffset 0.5s ease"/>
    ${checkmark}
  </svg>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPARKLE EFFECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function triggerSparkles() {
  const colors = ['#c084fc', '#22d3ee', '#f472b6', '#facc15', '#a78bfa', '#34d399'];
  for (let i = 0; i < 30; i++) {
    const el = document.createElement('div');
    el.className = 'sparkle';
    const size = 4 + Math.random() * 8;
    el.style.cssText = `
      left: ${Math.random() * 100}%; top: -10px;
      width: ${size}px; height: ${size}px;
      background: ${colors[Math.floor(Math.random() * colors.length)]};
      animation: sparkle-fall ${1 + Math.random() * 1.5}s ease-in ${Math.random() * 0.5}s forwards;
    `;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPINNER LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let spinnerInterval = null;

function startSpinner() {
  const incomplete = state.kits.filter(k => !getKitStats(k).isComplete);
  if (incomplete.length === 0) return;

  state.spinning = true;
  state.pickerResult = null;
  render();

  let tick = 0;
  const totalTicks = 25 + Math.floor(Math.random() * 15);
  const winnerIdx = Math.floor(Math.random() * incomplete.length);
  let speed = 50;

  function doTick() {
    tick++;
    const idx = tick % incomplete.length;
    const displayEl = document.getElementById('spinner-display');
    if (displayEl) {
      const k = incomplete[idx];
      displayEl.innerHTML = `
        <div style="color:var(--purple-light);font-size:16px;margin-bottom:4px">Kit #${k.number}</div>
        <div style="font-family:var(--font-display);font-size:22px;font-weight:700;color:var(--text-bright)">${escHtml(k.name)}</div>
      `;
    }

    if (tick >= totalTicks) {
      state.spinning = false;
      state.pickerResult = incomplete[winnerIdx];
      triggerSparkles();
      render();
      return;
    }

    if (tick > totalTicks - 10) {
      speed = 50 + (tick - (totalTicks - 10)) * 40;
    }
    spinnerInterval = setTimeout(doTick, speed);
  }

  spinnerInterval = setTimeout(doTick, speed);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navigateTo(view, kitId = null) {
  state.view = view;
  if (kitId !== null) state.selectedKitId = kitId;
  state.editingDesignId = null;
  render();
  window.scrollTo(0, 0);
}

function handleAddKit() {
  const num = parseInt(state.addNumber);
  const total = parseInt(state.addTotal);
  const completed = parseInt(state.addCompleted) || 0;
  if (!num || !total) return;

  const kitData = {
    number: num,
    name: state.addName.trim() || `Kit #${num}`,
    designs: createDesigns(total, Math.min(completed, total)),
    createdAt: Date.now(),
  };

  addKitToFirebase(kitData);
  showToast(`Kit #${num} added!`);

  if (state.bulkMode) {
    state.addNumber = String(num + 1);
    state.addName = '';
    state.addTotal = '';
    state.addCompleted = '0';
    render();
    // Focus kit name field for speed
    setTimeout(() => {
      const el = document.getElementById('add-name-input');
      if (el) el.focus();
    }, 100);
  } else {
    state.addNumber = '';
    state.addName = '';
    state.addTotal = '';
    state.addCompleted = '0';
    navigateTo('home');
  }
}

function handleSaveEdit() {
  const kit = getSelectedKit();
  if (!kit) return;
  const num = parseInt(state.editNumber);
  const name = state.editName.trim() || `Kit #${num}`;
  const newTotal = parseInt(state.editTotal);
  if (!num || !newTotal) return;

  let designs = [...(kit.designs || [])];
  if (newTotal > designs.length) {
    // Add new designs
    for (let i = designs.length; i < newTotal; i++) {
      designs.push({ id: generateId(), name: '', completed: false });
    }
  } else if (newTotal < designs.length) {
    // Remove from end (uncompleted first)
    designs.sort((a, b) => (a.completed === b.completed ? 0 : a.completed ? -1 : 1));
    designs = designs.slice(0, newTotal);
    // Re-sort by original order isn't possible, but this is a reasonable approach
  }

  updateKitInFirebase(kit.id, { number: num, name, designs });
  showToast('Kit updated!');
  navigateTo('detail', kit.id);
}

function handleDeleteKit(id) {
  deleteKitFromFirebase(id);
  state.showDeleteModal = false;
  state.deleteTargetId = null;
  showToast('Kit deleted');
  navigateTo('home');
}

function toggleDesign(kitId, designId) {
  const kit = state.kits.find(k => k.id === kitId);
  if (!kit || !kit.designs) return;

  const designs = kit.designs.map(d => {
    if (d.id === designId) return { ...d, completed: !d.completed };
    return d;
  });

  const wasComplete = getKitStats(kit).isComplete;
  updateKitInFirebase(kitId, { designs });

  // Check if kit just became complete
  const newCompleted = designs.filter(d => d.completed).length;
  if (!wasComplete && newCompleted === designs.length) {
    setTimeout(triggerSparkles, 300);
    showToast('ğŸ‰ Kit complete!');
  }
}

function renameDesign(kitId, designId, newName) {
  const kit = state.kits.find(k => k.id === kitId);
  if (!kit || !kit.designs) return;

  const designs = kit.designs.map(d => {
    if (d.id === designId) return { ...d, name: newName };
    return d;
  });

  updateKitInFirebase(kitId, { designs });
  state.editingDesignId = null;
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESCAPE HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const app = document.getElementById('app');
  if (!app) return;

  if (!state.loaded) {
    app.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:center;height:100vh;height:100dvh">
        <div style="color:var(--purple-light);font-size:18px">Loading...</div>
      </div>`;
    return;
  }

  let html = '';

  switch (state.view) {
    case 'home': html = renderHome(); break;
    case 'add': html = renderAdd(); break;
    case 'detail': html = renderDetail(); break;
    case 'edit': html = renderEdit(); break;
    case 'picker': html = renderPicker(); break;
  }

  // Toast
  if (state.toast) {
    html += `<div class="toast" style="animation:toast-in 0.3s ease">${escHtml(state.toast)}</div>`;
  }

  // Delete modal
  if (state.showDeleteModal) {
    const dk = state.kits.find(k => k.id === state.deleteTargetId);
    html += `
      <div class="modal-overlay" onclick="closeDeleteModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
          <h3 style="font-family:var(--font-display);font-size:20px;color:var(--text-bright);margin-bottom:12px">Delete Kit?</h3>
          <p style="color:var(--text-dim);font-size:14px;margin-bottom:20px;line-height:1.5">
            Are you sure you want to delete <strong style="color:var(--text)">#${dk ? dk.number : ''} â€” ${dk ? escHtml(dk.name) : ''}</strong>? This can't be undone.
          </p>
          <div style="display:flex;gap:10px">
            <button class="btn-outline" style="flex:1;border-radius:12px" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn" style="flex:1;background:var(--red);border-radius:12px" onclick="handleDeleteKit('${state.deleteTargetId}')">Delete</button>
          </div>
        </div>
      </div>`;
  }

  app.innerHTML = html;
}

function closeDeleteModal(e) {
  state.showDeleteModal = false;
  state.deleteTargetId = null;
  render();
}

// â”€â”€ HOME VIEW â”€â”€
function renderHome() {
  const stats = getOverallStats();
  const filtered = getFilteredKits();
  const hasIncomplete = state.kits.some(k => !getKitStats(k).isComplete);

  let html = `<div class="screen" style="padding-bottom:100px">`;

  // Header
  html += `
    <div style="padding:24px 20px 20px;background:linear-gradient(180deg,rgba(124,58,237,0.08),transparent)">
      <h1 style="font-family:var(--font-display);font-size:26px;font-weight:700;
        background:linear-gradient(90deg,var(--pink),var(--cyan),var(--pink));
        background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;
        animation:gem-shimmer 4s linear infinite;margin-bottom:4px">
        â—† Paint Gem Tracker
      </h1>
      <p style="color:var(--text-dimmer);font-size:14px">
        ${stats.totalKits === 0
          ? 'Add your first kit to get started!'
          : `${stats.totalKits} kits Â· ${stats.completedDesigns} of ${stats.totalDesigns} designs done`}
      </p>
    </div>`;

  // Stats
  if (stats.totalKits > 0) {
    html += `
      <div style="padding:0 20px 16px;display:flex;gap:8px">
        <div class="stat-card"><div style="font-size:22px;font-weight:700;color:var(--green)">${stats.completedKits}</div><div style="font-size:11px;color:var(--text-dim);font-weight:600;letter-spacing:0.5px">Done</div></div>
        <div class="stat-card"><div style="font-size:22px;font-weight:700;color:var(--purple-light)">${stats.inProgressKits}</div><div style="font-size:11px;color:var(--text-dim);font-weight:600;letter-spacing:0.5px">Active</div></div>
        <div class="stat-card"><div style="font-size:22px;font-weight:700;color:var(--text-dimmer)">${stats.notStartedKits}</div><div style="font-size:11px;color:var(--text-dim);font-weight:600;letter-spacing:0.5px">New</div></div>
      </div>`;
  }

  // Pick button
  if (stats.totalKits > 0 && hasIncomplete) {
    html += `
      <div style="padding:0 20px 16px">
        <button class="btn btn-big" onclick="navigateTo('picker')" style="display:flex;align-items:center;justify-content:center;gap:8px">
          <span style="font-size:20px">â—†</span> Pick Next Kit
        </button>
      </div>`;
  }

  // Search & Filter
  if (stats.totalKits > 0) {
    html += `
      <div style="padding:0 20px 12px">
        <input class="input" value="${escHtml(state.search)}" oninput="state.search=this.value;render()"
          placeholder="Search kits..." style="margin-bottom:10px">
        <div style="display:flex;gap:6px;overflow-x:auto;padding-bottom:4px">
          ${['all', 'in_progress', 'not_started', 'completed'].map(f => {
            const labels = { all: 'All', in_progress: 'Started', not_started: 'Not Started', completed: 'Done' };
            return `<button class="pill ${state.filter === f ? 'active' : ''}"
              onclick="state.filter='${f}';render()">${labels[f]}</button>`;
          }).join('')}
        </div>
      </div>`;
  }

  // Kit list
  html += `<div style="padding:0 20px">`;
  if (filtered.length === 0 && stats.totalKits > 0) {
    html += `<div style="text-align:center;padding:40px;color:var(--text-dimmer)">No kits match this filter</div>`;
  }

  filtered.forEach(kit => {
    const s = getKitStats(kit);
    html += `
      <div class="kit-item ${s.isComplete ? 'complete' : ''}" onclick="navigateTo('detail','${kit.id}')">
        ${progressRingSvg(s.completed, s.total, 44)}
        <div style="flex:1;min-width:0">
          <div style="font-size:15px;font-weight:600;color:${s.isComplete ? 'var(--green)' : 'var(--text-bright)'};
            overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
            #${kit.number} â€” ${escHtml(kit.name)}
          </div>
          <div style="font-size:13px;color:var(--text-dim);margin-top:2px">
            ${s.completed}/${s.total} designs Â· ${s.pct}%
          </div>
        </div>
        <div style="color:#334155;font-size:18px">â€º</div>
      </div>`;
  });

  html += `</div>`;

  // FAB
  html += `
    <button class="fab" onclick="openAddKit()">+</button>`;

  html += `</div>`;
  return html;
}

function openAddKit() {
  if (state.kits.length > 0) {
    const maxNum = Math.max(...state.kits.map(k => k.number));
    state.addNumber = String(maxNum + 1);
  } else {
    state.addNumber = '1';
  }
  state.addName = '';
  state.addTotal = '';
  state.addCompleted = '0';
  navigateTo('add');
}

function updateAddBtn() {
  const btn = document.getElementById('add-kit-btn');
  if (!btn) return;
  const canAdd = state.addNumber && state.addTotal;
  if (canAdd) {
    btn.classList.remove('btn-disabled');
    btn.disabled = false;
  } else {
    btn.classList.add('btn-disabled');
    btn.disabled = true;
  }
}

function updateEditBtn() {
  const btn = document.getElementById('edit-save-btn');
  if (!btn) return;
  const canSave = state.editNumber && state.editTotal;
  if (canSave) {
    btn.classList.remove('btn-disabled');
    btn.disabled = false;
  } else {
    btn.classList.add('btn-disabled');
    btn.disabled = true;
  }
}

// â”€â”€ ADD VIEW â”€â”€
function renderAdd() {
  const canAdd = state.addNumber && state.addTotal;
  let html = `<div class="screen" style="padding-bottom:40px">`;

  html += `
    <div class="header">
      <button class="back-btn" onclick="state.bulkMode=false;navigateTo('home')">â† Back</button>
    </div>
    <div style="padding:10px 24px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">
        <h2 style="font-family:var(--font-display);font-size:24px;color:var(--text-bright)">
          ${state.bulkMode ? 'Quick Add Kits' : 'Add Kit'}
        </h2>
        <button class="pill ${state.bulkMode ? 'active' : ''}"
          onclick="state.bulkMode=!state.bulkMode;render()">
          ${state.bulkMode ? 'Bulk Mode âœ“' : 'Bulk Mode'}
        </button>
      </div>`;

  if (state.bulkMode) {
    html += `
      <div style="padding:12px 16px;background:rgba(167,139,250,0.08);border-radius:12px;
        border:1px solid rgba(167,139,250,0.15);margin-bottom:20px;font-size:13px;
        color:#94a3b8;line-height:1.5">
        Quick add mode â€” after adding a kit, the form stays open with the next number ready.
      </div>`;
  }

  html += `
    <div style="display:flex;flex-direction:column;gap:16px">
      <div>
        <label class="label">Kit Number *</label>
        <input class="input" type="number" value="${escHtml(state.addNumber)}"
          oninput="state.addNumber=this.value;updateAddBtn()" placeholder="e.g. 1">
      </div>
      <div>
        <label class="label">Kit Name</label>
        <input class="input" id="add-name-input" value="${escHtml(state.addName)}"
          oninput="state.addName=this.value" placeholder="e.g. Ocean Sunset">
      </div>
      <div>
        <label class="label">Total Designs *</label>
        <input class="input" type="number" value="${escHtml(state.addTotal)}"
          oninput="state.addTotal=this.value;updateAddBtn()" placeholder="e.g. 12">
      </div>
      <div>
        <label class="label">Designs Already Completed</label>
        <input class="input" type="number" value="${escHtml(state.addCompleted)}"
          oninput="state.addCompleted=this.value" placeholder="0">
      </div>

      <button id="add-kit-btn" class="btn ${!canAdd ? 'btn-disabled' : ''}" style="margin-top:8px"
        onclick="handleAddKit()" ${!canAdd ? 'disabled' : ''}>
        ${state.bulkMode ? 'Add & Next' : 'Add Kit'}
      </button>

      ${state.bulkMode ? `
        <button class="btn-outline" onclick="state.bulkMode=false;navigateTo('home')">
          Done Adding
        </button>` : ''}
    </div>
    </div>
  </div>`;

  return html;

  return html;
}

// â”€â”€ DETAIL VIEW â”€â”€
function renderDetail() {
  const kit = getSelectedKit();
  if (!kit) { navigateTo('home'); return ''; }

  const s = getKitStats(kit);
  const designs = kit.designs || [];

  let html = `<div class="screen" style="padding-bottom:40px">`;

  // Header
  html += `
    <div class="header">
      <button class="back-btn" onclick="navigateTo('home')">â† Back</button>
      <div style="flex:1"></div>
      <button style="background:none;border:none;color:var(--text-dim);font-size:14px;cursor:pointer;padding:8px;font-family:var(--font-body)"
        onclick="openEditKit()">Edit</button>
      <button style="background:none;border:none;color:var(--red);font-size:14px;cursor:pointer;padding:8px;font-family:var(--font-body)"
        onclick="state.showDeleteModal=true;state.deleteTargetId='${kit.id}';render()">Delete</button>
    </div>`;

  // Kit Info
  html += `
    <div style="text-align:center;padding:20px 24px 24px">
      <div style="color:var(--purple-light);font-size:14px;font-weight:600;letter-spacing:1px;margin-bottom:6px">
        KIT #${kit.number}
      </div>
      <h1 style="font-family:var(--font-display);font-size:28px;font-weight:700;
        color:${s.isComplete ? 'var(--green)' : 'var(--text-bright)'};margin-bottom:24px">
        ${escHtml(kit.name)}${s.isComplete ? ' âœ¨' : ''}
      </h1>

      <div style="display:flex;justify-content:center;margin-bottom:20px">
        ${progressRingSvg(s.completed, s.total, 120)}
      </div>

      <div style="font-size:32px;font-weight:700;color:var(--text-bright)">
        ${s.completed} <span style="color:var(--text-dimmer);font-size:20px">of</span> ${s.total}
      </div>
      <div style="color:var(--text-dim);font-size:14px;margin-top:4px">designs completed Â· ${s.pct}%</div>

      <div class="progress-bar" style="margin:24px auto 0;max-width:280px">
        <div class="progress-fill" style="width:${s.pct}%;
          background:${s.isComplete
            ? 'linear-gradient(90deg, var(--green), var(--cyan))'
            : 'linear-gradient(90deg, var(--purple), var(--purple-light))'}">
        </div>
      </div>
    </div>`;

  // Completion banner
  if (s.isComplete) {
    html += `
      <div style="margin:0 24px 20px;text-align:center;padding:20px;
        background:linear-gradient(135deg,rgba(52,211,153,0.1),rgba(34,211,238,0.1));
        border-radius:16px;border:1px solid rgba(52,211,153,0.2)">
        <div style="font-size:24px">ğŸ‰</div>
        <div style="color:var(--green);font-weight:600;font-size:16px;margin-top:4px">Kit Complete!</div>
      </div>`;
  }

  // Design list
  html += `
    <div style="padding:0 24px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <h3 style="font-size:16px;font-weight:600;color:var(--text-bright)">Designs</h3>
        <span style="font-size:13px;color:var(--text-dim)">Tap to complete Â· Click to Rename</span>
      </div>`;

  designs.forEach((design, idx) => {
    const displayName = design.name || `Design #${idx + 1}`;
    const isEditing = state.editingDesignId === design.id;

    if (isEditing) {
      html += `
        <div class="design-item" style="gap:8px">
          <input class="rename-input" id="rename-${design.id}" value="${escHtml(design.name)}"
            placeholder="Design #${idx + 1}"
            onkeydown="if(event.key==='Enter'){renameDesign('${kit.id}','${design.id}',this.value)}"
            onblur="renameDesign('${kit.id}','${design.id}',this.value)">
          <button style="background:none;border:none;color:var(--purple-light);font-size:13px;cursor:pointer;white-space:nowrap;font-family:var(--font-body)"
            onclick="renameDesign('${kit.id}','${design.id}',document.getElementById('rename-${design.id}').value)">
            Save
          </button>
        </div>`;
    } else {
      html += `
        <div class="design-item ${design.completed ? 'done' : ''}"
          onclick="toggleDesign('${kit.id}','${design.id}')"
          oncontextmenu="event.preventDefault();state.editingDesignId='${design.id}';render();setTimeout(()=>{const el=document.getElementById('rename-${design.id}');if(el)el.focus()},50)"
          ontouchstart="this._longPress=setTimeout(()=>{state.editingDesignId='${design.id}';render();setTimeout(()=>{const el=document.getElementById('rename-${design.id}');if(el)el.focus()},50)},500)"
          ontouchend="clearTimeout(this._longPress)"
          ontouchmove="clearTimeout(this._longPress)">
          <div class="design-checkbox ${design.completed ? 'checked' : ''}">
            ${design.completed ? `<svg width="14" height="14" viewBox="0 0 14 14" fill="none">
              <path d="M2 7L5.5 10.5L12 3.5" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>` : ''}
          </div>
          <div style="flex:1;min-width:0">
            <div style="font-size:15px;color:${design.completed ? 'var(--green)' : 'var(--text)'};
              ${design.completed ? 'text-decoration:line-through;opacity:0.7' : ''};
              overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
              ${escHtml(displayName)}
            </div>
          </div>
          <button style="background:none;border:none;color:var(--text-dimmer);font-size:11px;cursor:pointer;padding:4px 8px;font-family:var(--font-body)"
            onclick="event.stopPropagation();state.editingDesignId='${design.id}';render();setTimeout(()=>{const el=document.getElementById('rename-${design.id}');if(el)el.focus()},50)">
            rename
          </button>
        </div>`;
    }
  });

  html += `</div></div>`;
  return html;
}

function openEditKit() {
  const kit = getSelectedKit();
  if (!kit) return;
  state.editNumber = String(kit.number);
  state.editName = kit.name;
  state.editTotal = String(kit.designs ? kit.designs.length : 0);
  navigateTo('edit');
}

// â”€â”€ EDIT VIEW â”€â”€
function renderEdit() {
  const kit = getSelectedKit();
  if (!kit) { navigateTo('home'); return ''; }

  const canSave = state.editNumber && state.editTotal;

  let html = `<div class="screen" style="padding-bottom:40px">`;
  html += `
    <div class="header">
      <button class="back-btn" onclick="navigateTo('detail','${kit.id}')">â† Cancel</button>
    </div>
    <div style="padding:10px 24px">
      <h2 style="font-family:var(--font-display);font-size:24px;color:var(--text-bright);margin-bottom:24px">Edit Kit</h2>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div>
          <label class="label">Kit Number</label>
          <input class="input" type="number" value="${escHtml(state.editNumber)}"
            oninput="state.editNumber=this.value;updateEditBtn()">
        </div>
        <div>
          <label class="label">Kit Name</label>
          <input class="input" value="${escHtml(state.editName)}"
            oninput="state.editName=this.value">
        </div>
        <div>
          <label class="label">Total Designs</label>
          <input class="input" type="number" value="${escHtml(state.editTotal)}"
            oninput="state.editTotal=this.value;updateEditBtn()">
          <div style="font-size:12px;color:var(--text-dimmer);margin-top:6px">
            Changing this will add or remove designs from the end of the list
          </div>
        </div>
        <button id="edit-save-btn" class="btn ${!canSave ? 'btn-disabled' : ''}" style="margin-top:8px"
          onclick="handleSaveEdit()" ${!canSave ? 'disabled' : ''}>
          Save Changes
        </button>
      </div>
    </div>
  </div>`;

  return html;
}

// â”€â”€ PICKER VIEW â”€â”€
function renderPicker() {
  const incompleteCount = state.kits.filter(k => !getKitStats(k).isComplete).length;
  const result = state.pickerResult;

  let html = `<div class="screen" style="padding-bottom:40px">`;

  html += `
    <div class="header">
      <button class="back-btn" onclick="state.pickerResult=null;state.spinning=false;clearTimeout(spinnerInterval);navigateTo('home')">â† Back</button>
    </div>
    <div style="text-align:center;padding:40px 24px">
      <h2 style="font-family:var(--font-display);font-size:28px;font-weight:700;color:var(--text-bright);margin-bottom:8px">
        â—† Pick Next Kit
      </h2>
      <p style="color:var(--text-dim);font-size:14px;margin-bottom:40px">
        ${incompleteCount} kit${incompleteCount !== 1 ? 's' : ''} remaining
      </p>

      <div class="spinner-box">
        ${!state.spinning && !result
          ? `<div style="color:var(--text-dimmer);font-size:16px">Tap the button to pick a kit!</div>`
          : ''}
        <div id="spinner-display" style="padding:${state.spinning ? '20px' : '0'}"></div>
      </div>`;

  if (result && !state.spinning) {
    const rs = getKitStats(result);
    html += `
      <div style="animation:slide-up 0.4s ease;margin-bottom:24px">
        <div style="background:linear-gradient(135deg,rgba(124,58,237,0.15),rgba(34,211,238,0.08));
          border:1px solid rgba(124,58,237,0.25);border-radius:16px;padding:24px;margin-bottom:16px">
          <div style="font-size:14px;color:var(--purple-light);font-weight:600;margin-bottom:4px">YOUR NEXT KIT</div>
          <div style="font-family:var(--font-display);font-size:24px;font-weight:700;color:var(--text-bright);margin-bottom:8px">
            #${result.number} â€” ${escHtml(result.name)}
          </div>
          <div style="color:var(--text-dim);font-size:14px">${rs.completed} of ${rs.total} designs done</div>
        </div>
        <div style="display:flex;gap:12px">
          <button class="btn" style="flex:1;box-shadow:0 4px 20px var(--purple-glow)"
            onclick="navigateTo('detail','${result.id}');state.pickerResult=null">
            Let's Go! â†’
          </button>
          <button class="btn-outline" style="padding:14px 20px"
            onclick="state.pickerResult=null;startSpinner()">
            Re-roll
          </button>
        </div>
      </div>`;
  }

  if (!result) {
    html += `
      <button class="btn btn-big ${state.spinning || incompleteCount === 0 ? 'btn-disabled' : ''}"
        style="max-width:300px;margin:0 auto"
        onclick="startSpinner()" ${state.spinning || incompleteCount === 0 ? 'disabled' : ''}>
        ${state.spinning ? 'Picking...' : incompleteCount === 0 ? 'All Kits Complete! ğŸ‰' : 'â—† Spin!'}
      </button>`;
  }

  html += `</div></div>`;
  return html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadKitsFromFirebase();
render();
</script>
</body>
</html>
